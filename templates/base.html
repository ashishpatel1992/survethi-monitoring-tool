<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap-table.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='favicon.ico') }}" rel="shortcut icon" >
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    <title>{{title}}</title>

    <!-- leaflet stylesheet and code -->
    <link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" rel="stylesheet" />
    <link href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" rel="stylesheet" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
    <script src="./static/js/leaflet-heat.js"></script>
    
</head>

<!-- statuses of the page -->
<script type="text/javascript">

    var parameters = {
        dateFrom: new Date(),
        dateTo: new Date(),
        center: [45.0485851,12.0318443],
        max_zoom: 18,
        initial_zoom: 11,
        refresh_interval: 5,
        refresh: false,
    }

    var disease_list = [];

    var layerGroup = new L.featureGroup();
    var mapController = new L.control.layers();

</script>



<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                {% include "time_selectors.html" %}
            </div>
            <div class="col">
                Main Filter
            </div>
        </div>
        <div class="row">
            <div class="col">
                {% include "map.html" %}
            </div>
            <div class="col">
                {% include "disease_list.html" %}
            </div>
        </div>

        <h2>DataTable</h2>
        <div class="row">
            <div class="col">
                {% include "primary_table.html" %}
            </div>
            <div class="col">
                {{ empty_space }}
            </div>
        </div>

        <hr>
        <div class="row">
            <div class="col">
                Secondary Map
            </div>
            <div class="col">
                Secondary Filter
            </div>
        </div>
    </div>
</body>

<!-- Bootstrap Table stylesheets and code -->
<link href="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css" rel="stylesheet">
<script src="{{ url_for('static', filename='js/bootstrap-table.min.js') }}"></script>
<style type="text/css">
    #mapid { position: relative; }
    .notloading { display: none; }
    .loading {
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        background-color: white; border: solid 1px black; padding: 0.1em 1em 0.1em 1em;
        font-family: Verdana,Arial,'Lucida Grande',Sans-Serif;
    }
    .list-group{
        max-height: 300px;
        margin-bottom: 10px;
        overflow-y:auto;
        -webkit-overflow-scrolling: touch;
    }
</style>
<script>
    var mymap = L.map('mapid').setView(parameters.center, parameters.initial_zoom);
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: parameters.max_zoom,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1Ijoibmljb3B1bnppIiwiYSI6ImNqamU5aHhrZzRqZWMzcW80ZjE3dWNwZnoifQ.6X2-0SFwNzx_mjXrk9cysw'
    }).addTo(mymap);
</script>

<!-- events and functions of the page -->
<script type="text/javascript">
    
    /**
     * (function) initialize components
     */
    function initialize(){
        var button_refresh = $('#button_refresh');
        if (!parameters.refresh) {
            button_refresh.removeClass('btn-outline-success');
            button_refresh.addClass('btn-danger');
            button_refresh.html('Stopped');
        } else {
            button_refresh.addClass('btn-outline-success');
            button_refresh.removeClass('btn-danger');
            button_refresh.html('Refreshing');
        }
        parameters.refresh_interval = $('#select_interval').val() * 60; // minutes
        mymap.addControl(new L.Control.Fullscreen());
    }

    /**
     * (function) Refresh function
     */
     function refresh(refresh) {
        if (refresh || parameters.refresh) {
            //alert('Refresh!');
            var newUrl = get_url();
            fetch_data(newUrl);
            myTimeout = setTimeout(refresh, parameters.refresh_interval * 1000);
        }
    }

    /**
     * (function) build the url with parameters
     */
    function get_url() {
        var query =  'http://127.0.0.1:5000/query_group';
        query = query.concat('/').concat(parameters.dateFrom.toISOString().split('T')[0]);
        query = query.concat('/').concat(parameters.dateTo.toISOString().split('T')[0]);
        console.log(query);
        return query;
    }

    /**
     * (function) show loading indicators
     */
    function setLoading(loading) {
        if (loading) {
            $('#map-loading-indicator').attr("class","loading");
            $('#table_primary').bootstrapTable('showLoading');
        } else {
            $('#map-loading-indicator').attr("class","notloading");
            $('#table_primary').bootstrapTable('hideLoading')
        }
    }
    
    /**
     * (sync) fetch data from URL
     */
    function fetch_data(newUrl) {
        setLoading(true);
        $.ajax({
            url: newUrl,
            success:function(data,status,xhr)
            {
                //console.log(data);
                //alert(JSON.stringify(data[0]));
                if (data.length > 0) {
                    show_markers(data);
                    update_table_data(data);
                    update_disease_list();                  
                } else {
                    cleanMap();
                    update_table_data(data);
                    clean_disease_list();
                }
            },
            complete: function(){
                setLoading(false);
            },
            error: function(){
                console.log('error');
            }
        })
    }

    /**
     * (function) clean map removing layers and controllers
     */
    function cleanMap() {
        layerGroup.clearLayers();
        mymap.removeControl(mapController);
    }

    /**
     * (function) update map adding layers and controllers
     */
    function show_markers(data) {

        cleanMap();

        var markersGroup1 = L.markerClusterGroup();
        var markerArray = [];
        disease_list = [];

        data.forEach(show_marker);

        var heatLayer = L.heatLayer(markerArray, {radius: 50})
        mapController = L.control.layers(null, {"heatLayer": heatLayer});

        layerGroup.addLayer(markersGroup1);
        layerGroup.addLayer(heatLayer);
        layerGroup.addTo(mymap);
        mymap.addControl(mapController);

        mymap.flyToBounds(markersGroup1.getBounds().pad(10));

        function show_marker(item, index) {
            
            if (item.LOC_LAT) {

                markerArray.push([item.LOC_LAT, item.LOC_LONG]);
                disease_list.push({'id': item.OPD_DIS_ID_A, 'desc': item.DIS_DESC, 'count': item.COUNT});

                var description = getMarkerDescription(item);
                markersGroup1.addLayer(
                    new L.marker([parseFloat(item.LOC_LAT), parseFloat(item.LOC_LONG)]).bindPopup(description)
                );

                /* if (item.OPD_DIS_ID_A == "424")
                    markersGroup1.addLayer(
                        new L.marker([parseFloat(item.LOC_LAT), parseFloat(item.LOC_LONG)], 
                            {icon: L.icon({iconUrl: 'static/img/blue_icon.png', iconSize: [32, 32]})}).bindPopup(description));
                else if (item.OPD_DIS_ID_A == "461")
                    markersGroup1.addLayer(
                        new L.marker([parseFloat(item.LOC_LAT), parseFloat(item.LOC_LONG)], 
                            {icon: L.icon({iconUrl: 'static/img/pink_icon.png', iconSize: [32, 32]})}).bindPopup(description)); */
            }
        }

        function getMarkerDescription(item) {
            if (item.COUNT) 
                return item.COUNT + "<br>" + item.LOC_CITY + "<br>" + item.LOC_ADDRESS + "<br>" + item.DIS_DESC
            else 
                return item.LOC_CITY + "<br>" + item.LOC_ADDRESS + "<br>" + item.DIS_DESC
        }

    }

    // Starts from here (main)
    $(document).ready(function (response) {

        initialize();
        myTimeout = setTimeout(refresh, parameters.refresh_interval * 1000);
    });

</script>


</html>